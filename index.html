<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>ESP32 BLE Sensor WebApp</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    #sensor-value { font-size: 2em; margin: 20px 0; }
    .btn { padding: 10px 20px; font-size: 1em; margin: 5px; }
    #status { margin: 10px 0; color: #555; }
  </style>
</head>
<body>
  <h1>ESP32 BLE Sensor WebApp</h1>
  <button id="connect-btn" class="btn">Mit ESP32 verbinden</button>
  <div id="status">Status: Nicht verbunden</div>
  <div>
    <strong>Sensorwert:</strong>
    <span id="sensor-value">---</span>
  </div>
  <div>
    <button id="led-on-btn" class="btn" disabled>LED AN</button>
    <button id="led-off-btn" class="btn" disabled>LED AUS</button>
  </div>

  <script>
    // UUIDs wie im Python Code
    const SERVICE_UUID        = "19b10000-e8f2-537e-4f6c-d104768a1214";
    const SENSOR_CHAR_UUID    = "19b10001-e8f2-537e-4f6c-d104768a1214";
    const LED_CHAR_UUID       = "19b10002-e8f2-537e-4f6c-d104768a1214";

    let device = null;
    let server = null;
    let sensorCharacteristic = null;
    let ledCharacteristic = null;

    const connectBtn = document.getElementById('connect-btn');
    const ledOnBtn = document.getElementById('led-on-btn');
    const ledOffBtn = document.getElementById('led-off-btn');
    const sensorValue = document.getElementById('sensor-value');
    const status = document.getElementById('status');

    // Hilfsfunktion zum Status anzeigen
    function showStatus(msg) {
      status.textContent = "Status: " + msg;
    }

    // Sensorwert-Notifications empfangen
    function handleSensorValue(event) {
      const value = new TextDecoder().decode(event.target.value);
      sensorValue.textContent = value;
    }

    // Verbindung herstellen und BLE-Services/Characteristics holen
    async function connect() {
      try {
        showStatus("Verbindung wird aufgebaut...");
        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: "ESP32" }],
          optionalServices: [SERVICE_UUID]
        });
        device.addEventListener('gattserverdisconnected', onDisconnected);

        server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        sensorCharacteristic = await service.getCharacteristic(SENSOR_CHAR_UUID);
        ledCharacteristic = await service.getCharacteristic(LED_CHAR_UUID);

        // Notifications abonnieren
        await sensorCharacteristic.startNotifications();
        sensorCharacteristic.addEventListener('characteristicvaluechanged', handleSensorValue);

        // Gleich mal den aktuellen Wert abfragen
        const val = await sensorCharacteristic.readValue();
        sensorValue.textContent = new TextDecoder().decode(val);

        ledOnBtn.disabled = false;
        ledOffBtn.disabled = false;
        showStatus("Verbunden mit ESP32!");

      } catch (error) {
        showStatus("Fehler bei Verbindung: " + error);
      }
    }

    // LED AN senden
    async function ledOn() {
      if (!ledCharacteristic) return;
      await ledCharacteristic.writeValue(Uint8Array.of(1));
    }
    // LED AUS senden
    async function ledOff() {
      if (!ledCharacteristic) return;
      await ledCharacteristic.writeValue(Uint8Array.of(0));
    }

    // Disconnected-Handler
    function onDisconnected() {
      showStatus("Verbindung getrennt");
      ledOnBtn.disabled = true;
      ledOffBtn.disabled = true;
    }

    connectBtn.addEventListener('click', connect);
    ledOnBtn.addEventListener('click', ledOn);
    ledOffBtn.addEventListener('click', ledOff);

  </script>
</body>
</html>
