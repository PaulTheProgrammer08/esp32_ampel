<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ESP32 Ampel â€” BLE Control</title>
<style>
  :root{
    --bg: #0f1724;
    --card: #0f2130;
    --muted: #9aa8b8;
    --accent: #06b6d4;
    --shadow: 0 8px 30px rgba(2,6,23,0.6);
  }
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto;
    background: var(--bg);
    color:#e6eef6;
    padding:16px;
  }
  .wrap{ max-width:980px; margin:0 auto; display:grid; grid-template-columns:1fr 360px; gap:20px;}
  header{ grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;}
  .card{ background:var(--card); border-radius:14px; padding:18px; box-shadow:var(--shadow);}
  .btn{padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; border:none;}
  .btn.primary{ background:#06b6d4; color:#042023;}
  .btn.secondary{ background:#253544; color:var(--muted);}
  .programs{ display:grid; gap:10px; grid-template-columns: repeat(2, 1fr); margin-top:12px;}
  .prog-btn{padding:12px; border-radius:10px; font-weight:700; cursor:pointer; background:rgba(255,255,255,0.02);}
  .prog-btn.active{outline:3px solid rgba(255,255,255,0.04);}
  .ampel-box{ display:flex; flex-direction:column; align-items:center; padding:18px; border-radius:14px; background:var(--card);}
  .ampel{ width:180px; background:#0b1117; padding:16px; border-radius:14px; display:flex; flex-direction:column; align-items:center;}
  .lamp{ width:86px; height:86px; border-radius:50%; margin:10px 0; display:flex; align-items:center; justify-content:center; cursor:pointer; opacity:0.55;}
  .lamp.red{ background: radial-gradient(circle,#ff7b7b,#8b0000);}
  .lamp.yellow{ background: radial-gradient(circle,#fff7a8,#b8860b);}
  .lamp.green{ background: radial-gradient(circle,#b8ffb8,#0b8b3d);}
  .lamp.on{ opacity:1; transform: scale(1.1);}
  input[type=range]{ width:100%; height:10px; border-radius:999px; }
</style>
</head>
<body>
<div class="wrap">
<header>
  <h1>ESP32 Ampel</h1>
  <div>
    <button id="btnConnect" class="btn primary">Verbinden</button>
    <button id="btnDisconnect" class="btn secondary" style="display:none">Trennen</button>
  </div>
</header>

<section class="card">
  <strong>Programme</strong>
  <div class="programs">
    <button class="prog-btn" data-mode="lauflicht">Lauflicht</button>
    <button class="prog-btn" data-mode="blinken">Blinken</button>
    <button class="prog-btn" data-mode="mode3">PingPong</button>
    <button class="prog-btn" data-mode="mode0">Fading</button>
    <button class="prog-btn" data-mode="stop">Stop</button>
  </div>
  <div style="margin-top:12px;">
    <label>Speed: <span id="uiSpeed">200</span> ms</label>
    <input id="speed" type="range" min="10" max="5000" step="10" value="200">
  </div>
</section>

<aside class="ampel-box">
  <div class="ampel">
    <div id="led0" class="lamp red" data-index="0"></div>
    <div id="led1" class="lamp yellow" data-index="1"></div>
    <div id="led2" class="lamp green" data-index="2"></div>
  </div>
  <div style="display:flex; gap:10px; margin-top:10px;">
    <button id="btnAllOn" class="btn primary">Alle an</button>
    <button id="btnAllOff" class="btn secondary">Alle aus</button>
  </div>
  <div style="margin-top:12px; color:var(--muted);" id="log"></div>
</aside>
</div>

<script>
const SERVICE_UUID='12345678-1234-5678-1234-56789abcdef0';
const MODE_UUID='12345678-1234-5678-1234-56789abcdef1';
const SPEED_UUID='12345678-1234-5678-1234-56789abcdef2';
const LED_UUID='12345678-1234-5678-1234-56789abcdef3';

let device=null, server=null, service=null, modeChar=null, speedChar=null, ledChar=null;
let ledStates=[0,0,0];
let modeLocal='', speedLocal=parseInt(document.getElementById('speed').value);

const leds=[document.getElementById('led0'), document.getElementById('led1'), document.getElementById('led2')];

function log(msg){ const e=document.getElementById('log'); e.innerHTML=`${new Date().toLocaleTimeString()} - ${msg}<br>`+e.innerHTML; }

async function connectBLE(){
  try{
    device = await navigator.bluetooth.requestDevice({filters:[{services:[SERVICE_UUID]}], optionalServices:[SERVICE_UUID]});
    device.addEventListener('gattserverdisconnected', ()=>{ log('Disconnected'); document.getElementById('btnDisconnect').style.display='none'; document.getElementById('btnConnect').style.display='inline-block'; });
    server = await device.gatt.connect();
    service = await server.getPrimaryService(SERVICE_UUID);
    modeChar = await service.getCharacteristic(MODE_UUID);
    speedChar = await service.getCharacteristic(SPEED_UUID);
    ledChar = await service.getCharacteristic(LED_UUID);
    log('Verbunden mit '+device.name);
    document.getElementById('btnConnect').style.display='none';
    document.getElementById('btnDisconnect').style.display='inline-block';
  }catch(e){ log('Fehler: '+e); }
}

function disconnectBLE(){ if(device && device.gatt.connected) device.gatt.disconnect(); log('Getrennt'); document.getElementById('btnDisconnect').style.display='none'; document.getElementById('btnConnect').style.display='inline-block'; }

function updateLedUI(){
  leds.forEach((el,i)=>{ el.classList.toggle('on',ledStates[i]>0); });
}

document.querySelectorAll('.prog-btn').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    modeLocal=btn.dataset.mode;
    // update UI active
    document.querySelectorAll('.prog-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    if(modeChar){ try{ await modeChar.writeValue(new TextEncoder().encode(modeLocal)); log('Mode '+modeLocal+' gesendet'); }catch(e){ log('Mode send error: '+e); } }
  });
});

leds.forEach((el,i)=>{ el.addEventListener('click', async ()=>{
  ledStates[i]=ledStates[i]?0:1023; updateLedUI();
  if(ledChar){ try{ await ledChar.writeValue(new TextEncoder().encode(ledStates.map((v,j)=>j+':'+v).join(';'))); log('LED set '+i+':'+ledStates[i]); }catch(e){ log('LED send err: '+e); } }
}); });

document.getElementById('btnAllOff').addEventListener('click', async ()=>{
  ledStates=[0,0,0]; updateLedUI();
  if(ledChar){ try{ await ledChar.writeValue(new TextEncoder().encode(ledStates.map((v,j)=>j+':'+v).join(';'))); log('Alle aus'); }catch(e){ log('LED send err: '+e); } }
});
document.getElementById('btnAllOn').addEventListener('click', async ()=>{
  ledStates=[1023,1023,1023]; updateLedUI();
  if(ledChar){ try{ await ledChar.writeValue(new TextEncoder().encode(ledStates.map((v,j)=>j+':'+v).join(';'))); log('Alle an'); }catch(e){ log('LED send err: '+e); } }
});

document.getElementById('btnConnect').addEventListener('click', connectBLE);
document.getElementById('btnDisconnect').addEventListener('click', disconnectBLE);

document.getElementById('speed').addEventListener('input', async (ev)=>{
  speedLocal=parseInt(ev.target.value);
  document.getElementById('uiSpeed').textContent=speedLocal;
  if(speedChar){ try{ await speedChar.writeValue(new TextEncoder().encode(speedLocal.toString())); log('Speed gesendet: '+speedLocal); }catch(e){ log('Speed send err: '+e); } }
});
</script>
</body>
</html>
